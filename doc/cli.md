# Command Line Interface (CLI)

KPConv-Torch is a library with a *command-line interface* (CLI). It works for training a neural network model on a points cloud dataset.

> Until now, only compatibility with the [S3DIS dataset](https://guochengqian.github.io/PointNeXt/examples/s3dis/) has been developed.

The following options are available, behind the command `kpconv`:
- `preprocess`;
- `train`;
- `test`.

They are detailed below.


## Preprocess

The `preprocess` command corresponds to the preprocessing of the data labeled files, used for training the model, with the following options:
- `-c` or `--configfile`: path to the configuration file;
- `-d` or `--datapath`: path to the labeled points clouds data files.

The `preprocess` command generates two folders, inside the folder pointed by the `-d` option:
- `input_xxxx`, which contains the KD-trees files (`.pkl`) and the conversion of the points clouds for each area in a unique `.ply` file (`xxxx` being a parameter of the program);
- `original_ply`, which contains a copy of each generated points clouds `.ply` file.


## Train

The `train` command corresponds to the training of the model. The following options can be used with it:
- `-c` or `--configfile`: path to the configuration file;
- `-d` or `--datapath`: path to the folder of labeled points clouds data files, which should contain the `input_xxxx` and the `original_ply` folders, generated by the preprocessing step (mandatory);
- `-l` or `--chosen-log`: path to an already trained KPConv model log folder on the file system (mutually exclusive with the `-o` option);
- `-o` or `--output-folder`: path to a folder which will contain the new KPConv model log folder on the file system (mutually exclusive with the `-l` option).
- `-E/--max-epoch`: upper bound for the number of training epochs (useful for functional tests)
- `g/--checkpoint-gap`: Frequency at which training checkpoints are saved on disk (in terms of epochs)
- `-e/--epoch-steps`: Number of steps per training epoch
- `-v/--validation-size`: Number of steps per validation process, after each epoch

The `train` command generates :
- a `parameters.txt` file containing a summary of the parameters of the calibration and of the calibrated model;
- a `training.txt` file containing an accuracy measure and a calculation time, for each epoch (iteration) of the training;
- a `val_IoUs.txt` file, containing the values of a validation indicator called *intersection over union*, that compares for each semantic class the ground truth and the predictions.
    - The ratio tends toward 1 (meaning that intersection tends toward union) when the predictions are good.
    - When the predictions are bad, the intersection tends to be empty and the ratio tends to 0.
- a `checkpoints` folder, containing `.tar` files, corresponding to the different epochs;
- a `potentials` folder, containing an `Area_5.ply` file, with validation data inside.
- two files in a `calibration` sub-folder, which is located in the folder pointed by the `-d` option, containing the data used to train the model:
    - `batch_limits.pkl`: ;
    - `neighbors_limits.pkl`: ;


## Test

The `test` command corresponds to the application of the model on an unlabeled dataset. The following options are available with it:
- `-c` or `--configfile`: path to the configuration file;
- `-d` or `--datapath` (mandatory):
    - path to the folder of labeled points clouds data files used to train the model, which should contain two folders, generated by the preprocessing step:
        - `input_xxxx`;
        - `original_ply`;
- `-l` or `--chosen-log`: path of the KPConv log folder on the file system, in which will be stored the trained model (mandatory);
- `-f` or `--filename`: file on which to predict semantic labels, using the trained model (optional).
- `-n/--n-votes`: Number of positive vote during inference process (stop condition to reach)
- `-p/--potential-increment`: Increment of inference potential at which results are saved
- `-v/--validation-size`: Number of steps per validation process, after each epoch

The `test` command generates:
- two files in a `calibration` sub-folder, which is located in the folder pointed by the `-d` option, containing the data used to train the model:
    - `batch_limits.pkl`: ;
    - `neighbors_limits.pkl`: ;
- three folders, in the folder pointed by the `-l` option, containing the trained model:
    - `potentials`: ;
    - `predictions`: predictions for point, based on the highest probability;
    - `probs`: probability that each point belongs to each class of the nomenclature.

Original code from Hugues Thomas has two more modules, `visualize.py` and `plot_convergence.py`, which are not included in the CLI. Nevertheless, they are not maintained in the version of the library contained in this repository.

### Accepted data formats

The file on which the inference must be done, pointed behind the `-f` option, can have one of the following formats:
- `.las` or its lossless compressed equivalent `.laz`;
- `.xyz`;
- `.ply`.

Concerning `.las` format, the representation of colors is done on the basis of three 2-bytes fields. The documentation for the LAS 1.4 format (last one) is available [here](https://www.asprs.org/wp-content/uploads/2019/03/LAS_1_4_r14.pdf).
